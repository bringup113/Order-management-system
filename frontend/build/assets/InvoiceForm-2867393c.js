import{_ as Z,M as H,b as K,r as b,x as Q,c as U,a1 as Y,y as $,o as y,e as S,i as d,z as _,f as e,w as a,J as ee,k as L,E as k,t as te,A as oe,a5 as ae,L as le,n as i,X as q,Y as z,Z as re,q as ne,s as se,C as de,P as ie,B as ue,V as me,W as ce,a2 as pe,D as fe,F as ge,G as ve,g as _e}from"./index-518491b2.js";/* empty css                   *//* empty css                   *//* empty css                *//* empty css                     *//* empty css                        *//* empty css               *//* empty css                 *//* empty css                        *//* empty css                  *//* empty css               *//* empty css                       */import{a as be,u as ye,c as we}from"./invoice-101f2e3d.js";const Ne={name:"InvoiceForm",setup(){const C=H(),o=K(),h=b(null),t=b(!1),D=b(!1),A=b(!1),v=Q(()=>!!C.params.id),r=U({invoiceNo:"",generatedDate:new Date().toISOString().split("T")[0],status:"unpaid",totalAmount:0,paidAmount:0,unpaidAmount:0,customerId:"",agentId:"",remarks:"",orderIds:[]}),p=U({generatedDate:[{required:!0,message:"请选择生成日期",trigger:"change"}],status:[{required:!0,message:"请选择账单状态",trigger:"change"}],customerId:[{required:!0,message:"请选择客户",trigger:"change"}],agentId:[{required:!0,message:"请选择代理商",trigger:"change"}]}),c=b([]),V=b(null),N=b([{id:1,name:"北京旅行社",contactPerson:"赵六",contactPhone:"13600136000"},{id:2,name:"上海旅行社",contactPerson:"王五",contactPhone:"13800138000"},{id:3,name:"广州旅行社",contactPerson:"李四",contactPhone:"13900139000"}]),f=b(null),u=b([]),E=b([]),m=b([]),w=U({orderNo:"",status:""});Y(()=>r.agentId,n=>{n?f.value=N.value.find(s=>s.id===n):f.value=null}),Y(()=>r.customerId,n=>{n?V.value=c.value.find(s=>s.id===n):V.value=null});const P=async n=>{if(n){D.value=!0;try{setTimeout(()=>{c.value=[{id:1,name:"张三",passportNo:"E12345678",nationality:"中国"},{id:2,name:"李四",passportNo:"E87654321",nationality:"中国"},{id:3,name:"John Smith",passportNo:"P12345678",nationality:"美国"}].filter(s=>s.name.toLowerCase().includes(n.toLowerCase())||s.passportNo.toLowerCase().includes(n.toLowerCase())),D.value=!1},500)}catch(s){console.error("搜索客户失败:",s),D.value=!1}}else c.value=[]},T=()=>{if(!r.customerId){k.warning("请先选择客户");return}A.value=!0,m.value=[...u.value],I()},I=()=>{setTimeout(()=>{E.value=[{id:1,orderNo:"ORD20230001",orderDate:"2023-01-10",orderStatus:"completed",amount:3e3,customerName:"张三",productName:"日本旅游签证"},{id:2,orderNo:"ORD20230002",orderDate:"2023-01-12",orderStatus:"processing",amount:2e3,customerName:"张三",productName:"美国旅游签证"},{id:3,orderNo:"ORD20230003",orderDate:"2023-01-15",orderStatus:"pending",amount:1500,customerName:"张三",productName:"欧洲申根签证"}].filter(n=>{let s=!0;return w.orderNo&&!n.orderNo.includes(w.orderNo)&&(s=!1),w.status&&n.orderStatus!==w.status&&(s=!1),s})},300)},x=()=>{w.orderNo="",w.status="",I()},F=n=>{m.value=n},l=()=>{u.value=[...m.value],r.orderIds=u.value.map(n=>n.id),r.totalAmount=R(),r.unpaidAmount=r.totalAmount-r.paidAmount,A.value=!1},M=n=>{u.value.splice(n,1),r.orderIds=u.value.map(s=>s.id),r.totalAmount=R(),r.unpaidAmount=r.totalAmount-r.paidAmount},R=()=>u.value.reduce((n,s)=>n+s.amount,0),J=async()=>{const n=C.params.id;if(n){t.value=!0;try{const g=(await be(n)).data;Object.keys(r).forEach(O=>{g[O]!==void 0&&(r[O]=g[O])}),g.passport&&(r.customerId=g.passport.id,c.value=[g.passport],V.value=g.passport),g.agent&&(r.agentId=g.agent.id,f.value=g.agent),g.orders&&g.orders.length>0&&(u.value=g.orders,r.orderIds=u.value.map(O=>O.id))}catch(s){console.error("获取账单详情失败:",s),k.error("获取账单详情失败"),r.invoiceNo="INV20230001",r.generatedDate="2023-01-15",r.status="partial",r.totalAmount=5e3,r.paidAmount=2e3,r.unpaidAmount=3e3,r.remarks="这是一个测试账单",r.customerId=1,c.value=[{id:1,name:"张三",passportNo:"E12345678",nationality:"中国"}],V.value=c.value[0],r.agentId=1,f.value=N.value[0],u.value=[{id:1,orderNo:"ORD20230001",orderDate:"2023-01-10",orderStatus:"completed",amount:3e3,status:"active"},{id:2,orderNo:"ORD20230002",orderDate:"2023-01-12",orderStatus:"processing",amount:2e3,status:"active"}],r.orderIds=u.value.map(g=>g.id)}finally{t.value=!1}}},j=async()=>{h.value&&await h.value.validate(async n=>{if(n){if(u.value.length===0){k.warning("请至少选择一个订单");return}t.value=!0;try{const s={...r};v.value?(await ye(C.params.id,s),k.success("账单更新成功")):(await we(s),k.success("账单创建成功")),B()}catch(s){console.error("保存账单失败:",s),k.error("保存账单失败")}finally{t.value=!1}}else return k.warning("请填写必填项"),!1})},B=()=>{o.back()},G=n=>({pending:"待处理",processing:"处理中",completed:"已完成",cancelled:"已取消"})[n]||n,W=n=>({pending:"warning",processing:"primary",completed:"success",cancelled:"danger"})[n]||"",X=n=>`¥ ${parseFloat(n).toFixed(2)}`;return $(()=>{v.value&&J()}),{formRef:h,form:r,rules:p,loading:t,isEdit:v,passportLoading:D,passportOptions:c,selectedPassport:V,agentOptions:N,selectedAgent:f,orderDialogVisible:A,selectedOrders:u,availableOrders:E,tempSelectedOrders:m,orderSearch:w,searchPassports:P,showOrderSelectionDialog:T,searchOrders:I,resetOrderSearch:x,handleOrderSelectionChange:F,confirmOrderSelection:l,removeOrder:M,calculateTotalAmount:R,submitForm:j,goBack:B,getOrderStatusText:G,getOrderStatusType:W,formatCurrency:X}}},Se={class:"invoice-form-container"},Ve={class:"page-header"},ke={class:"header-actions"},De={key:0,class:"selected-info"},Ie={key:1,class:"no-selected"},Oe={key:0,class:"selected-info"},Ce={key:1,class:"no-selected"},he={class:"order-selection"},Ae={class:"order-selection-header"},Ee={key:0,class:"order-total"},Pe={class:"order-dialog-content"},Te={class:"dialog-footer"};function xe(C,o,h,t,D,A){const v=te,r=ne,p=se,c=de,V=ie,N=ue,f=me,u=ce,E=pe,m=fe,w=ge,P=ve,T=_e,I=oe,x=ae,F=le;return y(),S("div",Se,[d("div",Ve,[d("h1",null,_(t.isEdit?"编辑账单":"创建账单"),1),d("div",ke,[e(v,{onClick:t.goBack},{default:a(()=>o[11]||(o[11]=[i("取消")])),_:1},8,["onClick"]),e(v,{type:"primary",onClick:t.submitForm,loading:t.loading},{default:a(()=>o[12]||(o[12]=[i("保存")])),_:1},8,["onClick","loading"])])]),ee((y(),L(I,{class:"form-card"},{default:a(()=>[e(T,{ref:"formRef",model:t.form,rules:t.rules,"label-width":"120px","label-position":"right"},{default:a(()=>[o[21]||(o[21]=d("div",{class:"section-title"},"基本信息",-1)),e(N,{gutter:20},{default:a(()=>[e(c,{span:12},{default:a(()=>[e(p,{label:"账单编号",prop:"invoiceNo"},{default:a(()=>[e(r,{modelValue:t.form.invoiceNo,"onUpdate:modelValue":o[0]||(o[0]=l=>t.form.invoiceNo=l),placeholder:"系统自动生成",disabled:""},null,8,["modelValue"])]),_:1})]),_:1}),e(c,{span:12},{default:a(()=>[e(p,{label:"生成日期",prop:"generatedDate"},{default:a(()=>[e(V,{modelValue:t.form.generatedDate,"onUpdate:modelValue":o[1]||(o[1]=l=>t.form.generatedDate=l),type:"date",placeholder:"选择日期",style:{width:"100%"},"value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(N,{gutter:20},{default:a(()=>[e(c,{span:12},{default:a(()=>[e(p,{label:"账单状态",prop:"status"},{default:a(()=>[e(u,{modelValue:t.form.status,"onUpdate:modelValue":o[2]||(o[2]=l=>t.form.status=l),placeholder:"请选择账单状态",style:{width:"100%"}},{default:a(()=>[e(f,{label:"未支付",value:"unpaid"}),e(f,{label:"部分支付",value:"partial"}),e(f,{label:"已支付",value:"paid"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(c,{span:12},{default:a(()=>[e(p,{label:"总金额",prop:"totalAmount"},{default:a(()=>[e(E,{modelValue:t.form.totalAmount,"onUpdate:modelValue":o[3]||(o[3]=l=>t.form.totalAmount=l),precision:2,step:100,min:0,style:{width:"100%"},placeholder:"根据订单自动计算",disabled:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),o[22]||(o[22]=d("div",{class:"section-title"},"客户信息",-1)),e(N,{gutter:20},{default:a(()=>[e(c,{span:12},{default:a(()=>[e(p,{label:"选择客户",prop:"customerId"},{default:a(()=>[e(u,{modelValue:t.form.customerId,"onUpdate:modelValue":o[4]||(o[4]=l=>t.form.customerId=l),filterable:"",remote:"","reserve-keyword":"",placeholder:"请输入客户姓名或护照号码","remote-method":t.searchPassports,loading:t.passportLoading,style:{width:"100%"}},{default:a(()=>[(y(!0),S(q,null,z(t.passportOptions,l=>(y(),L(f,{key:l.id,label:`${l.name} (${l.passportNo})`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","remote-method","loading"])]),_:1})]),_:1}),e(c,{span:12},{default:a(()=>[e(p,{label:"客户信息"},{default:a(()=>[t.selectedPassport?(y(),S("div",De,[d("p",null,[o[13]||(o[13]=d("strong",null,"姓名：",-1)),i(_(t.selectedPassport.name),1)]),d("p",null,[o[14]||(o[14]=d("strong",null,"护照号：",-1)),i(_(t.selectedPassport.passportNo),1)]),d("p",null,[o[15]||(o[15]=d("strong",null,"国籍：",-1)),i(_(t.selectedPassport.nationality),1)])])):(y(),S("div",Ie,"未选择客户"))]),_:1})]),_:1})]),_:1}),o[23]||(o[23]=d("div",{class:"section-title"},"代理商信息",-1)),e(N,{gutter:20},{default:a(()=>[e(c,{span:12},{default:a(()=>[e(p,{label:"选择代理商",prop:"agentId"},{default:a(()=>[e(u,{modelValue:t.form.agentId,"onUpdate:modelValue":o[5]||(o[5]=l=>t.form.agentId=l),filterable:"",placeholder:"请选择代理商",style:{width:"100%"}},{default:a(()=>[(y(!0),S(q,null,z(t.agentOptions,l=>(y(),L(f,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(c,{span:12},{default:a(()=>[e(p,{label:"代理商信息"},{default:a(()=>[t.selectedAgent?(y(),S("div",Oe,[d("p",null,[o[16]||(o[16]=d("strong",null,"名称：",-1)),i(_(t.selectedAgent.name),1)]),d("p",null,[o[17]||(o[17]=d("strong",null,"联系人：",-1)),i(_(t.selectedAgent.contactPerson),1)]),d("p",null,[o[18]||(o[18]=d("strong",null,"电话：",-1)),i(_(t.selectedAgent.contactPhone),1)])])):(y(),S("div",Ce,"未选择代理商"))]),_:1})]),_:1})]),_:1}),o[24]||(o[24]=d("div",{class:"section-title"},"关联订单",-1)),d("div",he,[d("div",Ae,[e(v,{type:"primary",onClick:t.showOrderSelectionDialog},{default:a(()=>o[19]||(o[19]=[i("添加订单")])),_:1},8,["onClick"])]),e(P,{data:t.selectedOrders,border:"",style:{width:"100%"}},{default:a(()=>[e(m,{prop:"orderNo",label:"订单编号",width:"180"}),e(m,{prop:"orderDate",label:"下单日期",width:"120"}),e(m,{prop:"orderStatus",label:"订单状态",width:"100"},{default:a(l=>[e(w,{type:t.getOrderStatusType(l.row.orderStatus)},{default:a(()=>[i(_(t.getOrderStatusText(l.row.orderStatus)),1)]),_:2},1032,["type"])]),_:1}),e(m,{prop:"amount",label:"金额",width:"120"},{default:a(l=>[i(_(t.formatCurrency(l.row.amount)),1)]),_:1}),e(m,{label:"操作",width:"100"},{default:a(l=>[e(v,{type:"danger",size:"small",onClick:M=>t.removeOrder(l.$index)},{default:a(()=>o[20]||(o[20]=[i(" 移除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),t.selectedOrders.length>0?(y(),S("div",Ee,[d("span",null,"订单总金额："+_(t.formatCurrency(t.calculateTotalAmount())),1)])):re("",!0)]),o[25]||(o[25]=d("div",{class:"section-title"},"备注信息",-1)),e(p,{label:"备注",prop:"remarks"},{default:a(()=>[e(r,{type:"textarea",rows:3,modelValue:t.form.remarks,"onUpdate:modelValue":o[6]||(o[6]=l=>t.form.remarks=l),placeholder:"请输入备注信息"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1})),[[F,t.loading]]),e(x,{modelValue:t.orderDialogVisible,"onUpdate:modelValue":o[10]||(o[10]=l=>t.orderDialogVisible=l),title:"选择订单",width:"70%"},{default:a(()=>[d("div",Pe,[e(T,{inline:!0,class:"order-search-form"},{default:a(()=>[e(p,{label:"订单编号"},{default:a(()=>[e(r,{modelValue:t.orderSearch.orderNo,"onUpdate:modelValue":o[7]||(o[7]=l=>t.orderSearch.orderNo=l),placeholder:"请输入订单编号"},null,8,["modelValue"])]),_:1}),e(p,{label:"订单状态"},{default:a(()=>[e(u,{modelValue:t.orderSearch.status,"onUpdate:modelValue":o[8]||(o[8]=l=>t.orderSearch.status=l),placeholder:"请选择状态",clearable:""},{default:a(()=>[e(f,{label:"待处理",value:"pending"}),e(f,{label:"处理中",value:"processing"}),e(f,{label:"已完成",value:"completed"})]),_:1},8,["modelValue"])]),_:1}),e(p,null,{default:a(()=>[e(v,{type:"primary",onClick:t.searchOrders},{default:a(()=>o[26]||(o[26]=[i("查询")])),_:1},8,["onClick"]),e(v,{onClick:t.resetOrderSearch},{default:a(()=>o[27]||(o[27]=[i("重置")])),_:1},8,["onClick"])]),_:1})]),_:1}),e(P,{data:t.availableOrders,border:"",style:{width:"100%"},onSelectionChange:t.handleOrderSelectionChange},{default:a(()=>[e(m,{type:"selection",width:"55"}),e(m,{prop:"orderNo",label:"订单编号",width:"180"}),e(m,{prop:"orderDate",label:"下单日期",width:"120"}),e(m,{prop:"orderStatus",label:"订单状态",width:"100"},{default:a(l=>[e(w,{type:t.getOrderStatusType(l.row.orderStatus)},{default:a(()=>[i(_(t.getOrderStatusText(l.row.orderStatus)),1)]),_:2},1032,["type"])]),_:1}),e(m,{prop:"amount",label:"金额",width:"120"},{default:a(l=>[i(_(t.formatCurrency(l.row.amount)),1)]),_:1}),e(m,{prop:"customerName",label:"客户姓名",width:"120"}),e(m,{prop:"productName",label:"产品名称","min-width":"150"})]),_:1},8,["data","onSelectionChange"]),d("div",Te,[e(v,{onClick:o[9]||(o[9]=l=>t.orderDialogVisible=!1)},{default:a(()=>o[28]||(o[28]=[i("取消")])),_:1}),e(v,{type:"primary",onClick:t.confirmOrderSelection},{default:a(()=>o[29]||(o[29]=[i("确认")])),_:1},8,["onClick"])])])]),_:1},8,["modelValue"])])}const Xe=Z(Ne,[["render",xe],["__scopeId","data-v-5f14bfb8"]]);export{Xe as default};
