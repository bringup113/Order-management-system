import{_ as K,M as $,b as ee,r as g,a3 as R,a1 as te,y as ae,o as c,e as F,i as P,f as a,w as l,J as oe,k,E as O,a4 as f,t as re,A as le,L as de,n as x,X as E,Y as Q,Z as ne,q as se,s as ue,C as ie,P as ce,V as pe,W as me,B as ge,a2 as fe,D as ve,G as Ie,g as _e}from"./index-518491b2.js";/* empty css                   *//* empty css                *//* empty css                     *//* empty css                        *//* empty css               *//* empty css                 *//* empty css                        *//* empty css               *//* empty css                  *//* empty css                       */const he={name:"OrderEdit",setup(){const M=$(),d=ee(),S=g(null),r=g(!1),D=g(!1),u=g(null),y=g([]),V=g(!1),p=g([]),v=g(!1),U=g([]),i=g(!1),m=g([]),_=g([]),C={orderDate:[{required:!0,message:"请选择下单日期",trigger:"change"}],orderStatus:[{required:!0,message:"请选择订单状态",trigger:"change"}],paymentStatus:[{required:!0,message:"请选择支付状态",trigger:"change"}],passportId:[{required:!0,message:"请选择客户",trigger:"change"}],agentId:[{required:!0,message:"请选择代理商",trigger:"change"}]},h=async()=>{const e=M.params.id;if(!e){O.error("订单ID不能为空"),d.push({name:"OrderList"});return}r.value=!0;try{const s=(await f.get(`/api/orders/${e}`)).data,b=s.orderItems.map(I=>({id:I.id,productId:I.productId,productQuoteId:I.productQuoteId,agentProductPriceId:I.agentProductPriceId,unitPrice:I.unitPrice,quantity:I.quantity,subtotal:I.subtotal,remarks:I.remarks}));u.value={id:s.id,orderNo:s.orderNo,orderDate:s.orderDate,orderStatus:s.orderStatus,paymentStatus:s.paymentStatus,totalAmount:s.totalAmount,passportId:s.passportId,agentId:s.agentId,remarks:s.remarks,orderItems:b},await Promise.all([A(s.passportId),q(s.agentId),B(b)])}catch(o){console.error("获取订单详情失败:",o),O.error("获取订单详情失败"),d.push({name:"OrderList"})}finally{r.value=!1}},A=async e=>{try{const o=await f.get(`/api/passports/${e}`);y.value=[o.data]}catch(o){console.error("加载客户数据失败:",o)}},q=async e=>{try{const o=await f.get(`/api/agents/${e}`);p.value=[o.data]}catch(o){console.error("加载代理商数据失败:",o)}},B=async e=>{try{const o=e.map(w=>w.productId).filter(Boolean);if(o.length===0)return;const s=await f.get("/api/products",{params:{ids:o.join(",")}});U.value=s.data.data;const b=e.map(w=>w.productQuoteId).filter(Boolean);if(b.length>0){const w=await f.get("/api/product-quotes",{params:{ids:b.join(",")}});m.value=w.data.data}const I=e.map(w=>w.agentProductPriceId).filter(Boolean);if(I.length>0){const w=await f.get("/api/agent-product-prices",{params:{ids:I.join(",")}});_.value=w.data.data}}catch(o){console.error("加载产品数据失败:",o)}},L=R(async e=>{if(!(e.length<2)){V.value=!0;try{const o=await f.get("/api/passports",{params:{search:e,limit:10}});y.value=o.data.data}catch(o){console.error("搜索客户失败:",o)}finally{V.value=!1}}},500),t=R(async e=>{if(!(e.length<2)){v.value=!0;try{const o=await f.get("/api/agents",{params:{search:e,limit:10}});p.value=o.data.data}catch(o){console.error("搜索代理商失败:",o)}finally{v.value=!1}}},500),n=R(async e=>{if(!(e.length<2)){i.value=!0;try{const o=await f.get("/api/products",{params:{search:e,limit:10}});U.value=o.data.data}catch(o){console.error("搜索产品失败:",o)}finally{i.value=!1}}},500),T=e=>e?m.value.filter(o=>o.productId===e):[],j=e=>!e||!u.value.agentId?[]:_.value.filter(o=>o.productQuoteId===e&&o.agentId===u.value.agentId),z=async e=>{if(e.productQuoteId=null,e.agentProductPriceId=null,e.unitPrice=0,e.subtotal=0,!!e.productId)try{const s=(await f.get("/api/product-quotes",{params:{productId:e.productId}})).data.data;m.value=[...m.value.filter(b=>b.productId!==e.productId),...s]}catch(o){console.error("加载产品报价失败:",o)}},G=async e=>{if(e.agentProductPriceId=null,e.unitPrice=0,e.subtotal=0,!(!e.productQuoteId||!u.value.agentId))try{const s=(await f.get("/api/agent-product-prices",{params:{productQuoteId:e.productQuoteId,agentId:u.value.agentId}})).data.data;_.value=[..._.value.filter(b=>b.productQuoteId!==e.productQuoteId||b.agentId!==u.value.agentId),...s]}catch(o){console.error("加载代理商价格失败:",o)}},J=e=>{if(!e.agentProductPriceId)return;const o=_.value.find(s=>s.id===e.agentProductPriceId);o&&(e.unitPrice=o.sellingPrice,Y(e))},Y=e=>{e.subtotal=parseFloat((e.unitPrice*e.quantity).toFixed(2)),N()},N=()=>{if(!u.value||!u.value.orderItems)return;const e=u.value.orderItems.reduce((o,s)=>o+(s.subtotal||0),0);u.value.totalAmount=parseFloat(e.toFixed(2))},W=()=>{u.value&&u.value.orderItems.push({productId:null,productQuoteId:null,agentProductPriceId:null,unitPrice:0,quantity:1,subtotal:0,remarks:""})},X=e=>{u.value.orderItems.splice(e,1),N()},Z=()=>{d.back()},H=async()=>{var e,o;if(S.value)try{if(await S.value.validate(),u.value.orderItems.length===0){O.warning("请至少添加一个订单项目");return}for(const s of u.value.orderItems)if(!s.productId||!s.unitPrice||s.unitPrice<=0){O.warning("请完善订单项目信息");return}D.value=!0,await f.put(`/api/orders/${u.value.id}`,u.value),O.success("订单更新成功"),d.push({name:"OrderDetail",params:{id:u.value.id}})}catch(s){console.error("保存订单失败:",s),O.error("保存订单失败: "+(((o=(e=s.response)==null?void 0:e.data)==null?void 0:o.message)||s.message))}finally{D.value=!1}};return te(()=>{var e;return(e=u.value)==null?void 0:e.agentId},(e,o)=>{e!==o&&u.value&&(u.value.orderItems.forEach(s=>{s.agentProductPriceId=null,s.unitPrice=0,s.subtotal=0}),N())}),ae(()=>{h()}),{formRef:S,loading:r,saving:D,orderForm:u,rules:C,passportOptions:y,passportLoading:V,agentOptions:p,agentLoading:v,productOptions:U,productLoading:i,searchPassports:L,searchAgents:t,searchProducts:n,getQuoteOptions:T,getAgentPriceOptions:j,handleProductChange:z,handleQuoteChange:G,handleAgentPriceChange:J,calculateSubtotal:Y,addOrderItem:W,removeOrderItem:X,goBack:Z,handleSave:H}}},be={class:"order-edit-container"},we={class:"page-header"},ye={class:"header-actions"},Pe={class:"section-title"};function Ve(M,d,S,r,D,u){const y=re,V=se,p=ue,v=ie,U=ce,i=pe,m=me,_=ge,C=fe,h=ve,A=Ie,q=_e,B=le,L=de;return c(),F("div",be,[P("div",we,[d[10]||(d[10]=P("h1",null,"编辑订单",-1)),P("div",ye,[a(y,{onClick:r.goBack},{default:l(()=>d[8]||(d[8]=[x("取消")])),_:1},8,["onClick"]),a(y,{type:"primary",onClick:r.handleSave,loading:r.saving},{default:l(()=>d[9]||(d[9]=[x("保存")])),_:1},8,["onClick","loading"])])]),oe((c(),k(B,{class:"edit-card"},{default:l(()=>[r.orderForm?(c(),k(q,{key:0,ref:"formRef",model:r.orderForm,rules:r.rules,"label-width":"120px"},{default:l(()=>[d[13]||(d[13]=P("div",{class:"section-title"},"基本信息",-1)),a(_,{gutter:20},{default:l(()=>[a(v,{span:8},{default:l(()=>[a(p,{label:"订单编号",prop:"orderNo"},{default:l(()=>[a(V,{modelValue:r.orderForm.orderNo,"onUpdate:modelValue":d[0]||(d[0]=t=>r.orderForm.orderNo=t),disabled:""},null,8,["modelValue"])]),_:1})]),_:1}),a(v,{span:8},{default:l(()=>[a(p,{label:"下单日期",prop:"orderDate"},{default:l(()=>[a(U,{modelValue:r.orderForm.orderDate,"onUpdate:modelValue":d[1]||(d[1]=t=>r.orderForm.orderDate=t),type:"date",placeholder:"选择日期",style:{width:"100%"},"value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1})]),_:1}),a(v,{span:8},{default:l(()=>[a(p,{label:"订单状态",prop:"orderStatus"},{default:l(()=>[a(m,{modelValue:r.orderForm.orderStatus,"onUpdate:modelValue":d[2]||(d[2]=t=>r.orderForm.orderStatus=t),style:{width:"100%"}},{default:l(()=>[a(i,{label:"待处理",value:"pending"}),a(i,{label:"处理中",value:"processing"}),a(i,{label:"已完成",value:"completed"}),a(i,{label:"已取消",value:"cancelled"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(_,{gutter:20},{default:l(()=>[a(v,{span:8},{default:l(()=>[a(p,{label:"支付状态",prop:"paymentStatus"},{default:l(()=>[a(m,{modelValue:r.orderForm.paymentStatus,"onUpdate:modelValue":d[3]||(d[3]=t=>r.orderForm.paymentStatus=t),style:{width:"100%"}},{default:l(()=>[a(i,{label:"未支付",value:"unpaid"}),a(i,{label:"部分支付",value:"partial"}),a(i,{label:"已支付",value:"paid"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(v,{span:8},{default:l(()=>[a(p,{label:"订单金额",prop:"totalAmount"},{default:l(()=>[a(C,{modelValue:r.orderForm.totalAmount,"onUpdate:modelValue":d[4]||(d[4]=t=>r.orderForm.totalAmount=t),precision:2,step:100,min:0,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),d[14]||(d[14]=P("div",{class:"section-title"},"客户信息",-1)),a(_,{gutter:20},{default:l(()=>[a(v,{span:8},{default:l(()=>[a(p,{label:"选择客户",prop:"passportId"},{default:l(()=>[a(m,{modelValue:r.orderForm.passportId,"onUpdate:modelValue":d[5]||(d[5]=t=>r.orderForm.passportId=t),filterable:"",remote:"","reserve-keyword":"",placeholder:"请输入客户姓名或护照号","remote-method":r.searchPassports,loading:r.passportLoading,style:{width:"100%"}},{default:l(()=>[(c(!0),F(E,null,Q(r.passportOptions,t=>(c(),k(i,{key:t.id,label:`${t.name} (${t.passportNo})`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","remote-method","loading"])]),_:1})]),_:1})]),_:1}),d[15]||(d[15]=P("div",{class:"section-title"},"代理商信息",-1)),a(_,{gutter:20},{default:l(()=>[a(v,{span:8},{default:l(()=>[a(p,{label:"选择代理商",prop:"agentId"},{default:l(()=>[a(m,{modelValue:r.orderForm.agentId,"onUpdate:modelValue":d[6]||(d[6]=t=>r.orderForm.agentId=t),filterable:"",remote:"","reserve-keyword":"",placeholder:"请输入代理商名称","remote-method":r.searchAgents,loading:r.agentLoading,style:{width:"100%"}},{default:l(()=>[(c(!0),F(E,null,Q(r.agentOptions,t=>(c(),k(i,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","remote-method","loading"])]),_:1})]),_:1})]),_:1}),P("div",Pe,[d[12]||(d[12]=x(" 订单项目 ")),a(y,{type:"primary",size:"small",onClick:r.addOrderItem,style:{"margin-left":"10px"}},{default:l(()=>d[11]||(d[11]=[x(" 添加项目 ")])),_:1},8,["onClick"])]),a(A,{data:r.orderForm.orderItems,border:"",style:{width:"100%","margin-bottom":"20px"}},{default:l(()=>[a(h,{label:"产品名称","min-width":"180"},{default:l(t=>[a(m,{modelValue:t.row.productId,"onUpdate:modelValue":n=>t.row.productId=n,filterable:"",remote:"","reserve-keyword":"",placeholder:"请选择产品","remote-method":n=>r.searchProducts(n),loading:r.productLoading,style:{width:"100%"},onChange:n=>r.handleProductChange(t.row)},{default:l(()=>[(c(!0),F(E,null,Q(r.productOptions,n=>(c(),k(i,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","remote-method","loading","onChange"])]),_:1}),a(h,{label:"供应商报价",width:"180"},{default:l(t=>[a(m,{modelValue:t.row.productQuoteId,"onUpdate:modelValue":n=>t.row.productQuoteId=n,filterable:"",placeholder:"请选择供应商报价",style:{width:"100%"},disabled:!t.row.productId,onChange:n=>r.handleQuoteChange(t.row)},{default:l(()=>[(c(!0),F(E,null,Q(r.getQuoteOptions(t.row.productId),n=>(c(),k(i,{key:n.id,label:`${n.supplier.name} - ¥${n.costPrice}`,value:n.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled","onChange"])]),_:1}),a(h,{label:"代理商价格",width:"180"},{default:l(t=>[a(m,{modelValue:t.row.agentProductPriceId,"onUpdate:modelValue":n=>t.row.agentProductPriceId=n,filterable:"",placeholder:"请选择代理商价格",style:{width:"100%"},disabled:!t.row.productQuoteId||!r.orderForm.agentId,onChange:n=>r.handleAgentPriceChange(t.row)},{default:l(()=>[(c(!0),F(E,null,Q(r.getAgentPriceOptions(t.row.productQuoteId),n=>(c(),k(i,{key:n.id,label:`¥${n.sellingPrice}`,value:n.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled","onChange"])]),_:1}),a(h,{label:"单价",width:"120"},{default:l(t=>[a(C,{modelValue:t.row.unitPrice,"onUpdate:modelValue":n=>t.row.unitPrice=n,precision:2,step:10,min:0,style:{width:"100%"},onChange:n=>r.calculateSubtotal(t.row)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),a(h,{label:"数量",width:"100"},{default:l(t=>[a(C,{modelValue:t.row.quantity,"onUpdate:modelValue":n=>t.row.quantity=n,min:1,step:1,style:{width:"100%"},onChange:n=>r.calculateSubtotal(t.row)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),a(h,{label:"小计",width:"120"},{default:l(t=>[a(C,{modelValue:t.row.subtotal,"onUpdate:modelValue":n=>t.row.subtotal=n,precision:2,step:100,min:0,style:{width:"100%"},disabled:""},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),a(h,{label:"备注","min-width":"150"},{default:l(t=>[a(V,{modelValue:t.row.remarks,"onUpdate:modelValue":n=>t.row.remarks=n,placeholder:"备注"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),a(h,{label:"操作",width:"80",fixed:"right"},{default:l(t=>[a(y,{type:"danger",size:"small",icon:"Delete",circle:"",onClick:n=>r.removeOrderItem(t.$index)},null,8,["onClick"])]),_:1})]),_:1},8,["data"]),d[16]||(d[16]=P("div",{class:"section-title"},"备注信息",-1)),a(p,{label:"备注",prop:"remarks"},{default:l(()=>[a(V,{type:"textarea",rows:3,modelValue:r.orderForm.remarks,"onUpdate:modelValue":d[7]||(d[7]=t=>r.orderForm.remarks=t),placeholder:"请输入备注信息"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])):ne("",!0)]),_:1})),[[L,r.loading]])])}const qe=K(he,[["render",Ve],["__scopeId","data-v-61bf78fb"]]);export{qe as default};
