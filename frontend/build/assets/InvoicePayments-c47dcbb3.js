import{_ as $,M as ee,b as te,r as u,c as N,y as ae,o as v,e as j,i as s,f as n,w as l,J as oe,k as D,E as c,Q as L,I as ne,t as le,A as re,a5 as se,L as ie,n as m,z as f,Z as E,F as me,D as de,G as ue,a2 as pe,s as ye,V as ce,W as ve,P as fe,a6 as ge,q as _e,g as we,N as be,O as ke}from"./index-518491b2.js";/* empty css                   *//* empty css                 *//* empty css                   *//* empty css                     *//* empty css                 *//* empty css                       *//* empty css               *//* empty css                  *//* empty css                        *//* empty css                        *//* empty css                */import{a as he,b as Ve,e as De,r as Fe,f as Me,h as Ce}from"./invoice-101f2e3d.js";const Ae={name:"InvoicePayments",setup(){const I=ee(),e=te(),P=u(!1),t=u(!1),h=u(null),F=u([]),d=u(!1),g=u(null),b=u(!1),p=u(null),M=u([]),C=u(!1);u(null);const y=u(null),V=u(!1),x=u(""),i=N({paymentAmount:0,paymentMethod:"bank",paymentDate:new Date().toISOString().split("T")[0],voucherFile:null,remarks:""}),R=N({paymentAmount:[{required:!0,message:"请输入支付金额",trigger:"blur"},{validator:(a,r,B)=>{var q;r<=0?B(new Error("支付金额必须大于0")):r>(((q=h.value)==null?void 0:q.unpaidAmount)||0)?B(new Error("支付金额不能超过未支付金额")):B()},trigger:"blur"}],paymentMethod:[{required:!0,message:"请选择支付方式",trigger:"change"}],paymentDate:[{required:!0,message:"请选择支付日期",trigger:"change"}]}),_=N({status:"approved",remarks:""}),k=async()=>{const a=I.params.id;if(!a){c.error("账单ID不能为空");return}P.value=!0;try{const r=await he(a);h.value=L(r),A(a)}catch(r){console.error("获取账单详情失败:",r),c.error("获取账单详情失败"),h.value={id:a,invoiceNo:"INV20230001",generatedDate:"2023-01-15",status:"partial",totalAmount:5e3,paidAmount:2e3,unpaidAmount:3e3,passport:{name:"张三",passportNo:"E12345678",nationality:"中国"}},F.value=[{id:1,paymentAmount:2e3,paymentMethod:"bank",paymentDate:"2023-01-16",paymentStatus:"approved",reviewedBy:"管理员",reviewedAt:"2023-01-16 14:20:00",reviewRemarks:"支付凭证已确认",voucherUrl:"https://example.com/voucher1.jpg"}]}finally{P.value=!1}},A=async a=>{try{const r=await Ve(a);F.value=L(r)||[]}catch(r){console.error("获取支付记录失败:",r),F.value=[{id:1,paymentAmount:2e3,paymentMethod:"bank",paymentDate:"2023-01-16",paymentStatus:"approved",reviewedBy:"管理员",reviewedAt:"2023-01-16 14:20:00",reviewRemarks:"支付凭证已确认",voucherUrl:"https://example.com/voucher1.jpg"}]}},S=()=>{var a;b.value=!1,p.value=null,z(),i.paymentAmount=((a=h.value)==null?void 0:a.unpaidAmount)||0,d.value=!0},U=a=>{b.value=!0,p.value=a.id,z(),i.paymentAmount=a.paymentAmount,i.paymentMethod=a.paymentMethod,i.paymentDate=a.paymentDate,i.remarks=a.remarks,a.voucherUrl&&(M.value=[{name:"支付凭证",url:a.voucherUrl}]),d.value=!0},T=a=>{ne.confirm("确定要删除这条支付记录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await De(a.id),c.success("删除成功"),k()}catch(r){console.error("删除支付记录失败:",r),c.error("删除支付记录失败")}}).catch(()=>{})},o=(a,r)=>{y.value=a,_.status=r,_.remarks="",C.value=!0},w=async()=>{if(y.value){t.value=!0;try{await Fe(y.value.id,{status:_.status,remarks:_.remarks}),c.success("审核成功"),C.value=!1,k()}catch(a){console.error("审核支付记录失败:",a),c.error("审核支付记录失败")}finally{t.value=!1}}},z=()=>{i.paymentAmount=0,i.paymentMethod="bank",i.paymentDate=new Date().toISOString().split("T")[0],i.voucherFile=null,i.remarks="",M.value=[],g.value&&g.value.resetFields()},O=a=>{i.voucherFile=a.raw},Y=async()=>{g.value&&await g.value.validate(async a=>{if(a){t.value=!0;try{const r=new FormData;r.append("paymentAmount",i.paymentAmount),r.append("paymentMethod",i.paymentMethod),r.append("paymentDate",i.paymentDate),r.append("remarks",i.remarks),i.voucherFile&&r.append("voucherFile",i.voucherFile),b.value?(await Me(p.value,r),c.success("支付记录更新成功")):(await Ce(I.params.id,r),c.success("支付记录添加成功")),d.value=!1,k()}catch(r){console.error("保存支付记录失败:",r),c.error("保存支付记录失败")}finally{t.value=!1}}else return c.warning("请填写必填项"),!1})},G=a=>{x.value=a,V.value=!0},J=()=>{e.back()},Q=a=>({unpaid:"未支付",partial:"部分支付",paid:"已支付"})[a]||a,W=a=>({unpaid:"danger",partial:"warning",paid:"success"})[a]||"",Z=a=>({cash:"现金",bank:"银行转账",other:"其他"})[a]||a,H=a=>({pending:"待审核",approved:"已审核",rejected:"已拒绝"})[a]||a,K=a=>({pending:"warning",approved:"success",rejected:"danger"})[a]||"",X=a=>`¥ ${parseFloat(a).toFixed(2)}`;return ae(()=>{k()}),{loading:P,submitting:t,invoice:h,payments:F,paymentDialogVisible:d,paymentFormRef:g,paymentForm:i,paymentRules:R,isEditPayment:b,fileList:M,reviewDialogVisible:C,reviewForm:_,voucherDialogVisible:V,currentVoucherUrl:x,goBack:J,showAddPaymentDialog:S,handleEdit:U,handleDelete:T,handleReview:o,submitReview:w,handleFileChange:O,submitPaymentForm:Y,previewVoucher:G,getInvoiceStatusText:Q,getInvoiceStatusType:W,getPaymentMethodText:Z,getPaymentStatusText:H,getPaymentStatusType:K,formatCurrency:X}}},Ee={class:"invoice-payments-container"},Pe={class:"page-header"},xe={class:"header-actions"},Se={key:0,class:"invoice-info"},Ie={class:"info-item"},Re={class:"value"},Ue={class:"info-item"},Te={class:"value"},Be={class:"info-item"},Ne={class:"value"},je={class:"info-item"},ze={class:"value"},qe={class:"info-item"},Le={class:"value"},Oe={class:"info-item"},Ye={class:"value"},Ge={key:1},Je={class:"dialog-footer"},Qe={class:"dialog-footer"},We={class:"voucher-container"},Ze=["src"];function He(I,e,P,t,h,F){const d=le,g=me,b=re,p=de,M=ue,C=pe,y=ye,V=ce,x=ve,i=fe,R=ge,_=_e,k=we,A=se,S=be,U=ke,T=ie;return v(),j("div",Ee,[s("div",Pe,[e[13]||(e[13]=s("h1",null,"支付记录",-1)),s("div",xe,[n(d,{onClick:t.goBack},{default:l(()=>e[11]||(e[11]=[m("返回")])),_:1},8,["onClick"]),n(d,{type:"primary",onClick:t.showAddPaymentDialog},{default:l(()=>e[12]||(e[12]=[m("添加支付记录")])),_:1},8,["onClick"])])]),oe((v(),D(b,{class:"invoice-info-card"},{default:l(()=>{var o;return[t.invoice?(v(),j("div",Se,[s("div",Ie,[e[14]||(e[14]=s("span",{class:"label"},"账单编号：",-1)),s("span",Re,f(t.invoice.invoiceNo),1)]),s("div",Ue,[e[15]||(e[15]=s("span",{class:"label"},"客户姓名：",-1)),s("span",Te,f((o=t.invoice.passport)==null?void 0:o.name),1)]),s("div",Be,[e[16]||(e[16]=s("span",{class:"label"},"账单金额：",-1)),s("span",Ne,f(t.formatCurrency(t.invoice.totalAmount)),1)]),s("div",je,[e[17]||(e[17]=s("span",{class:"label"},"已支付金额：",-1)),s("span",ze,f(t.formatCurrency(t.invoice.paidAmount)),1)]),s("div",qe,[e[18]||(e[18]=s("span",{class:"label"},"未支付金额：",-1)),s("span",Le,f(t.formatCurrency(t.invoice.unpaidAmount)),1)]),s("div",Oe,[e[19]||(e[19]=s("span",{class:"label"},"账单状态：",-1)),s("span",Ye,[n(g,{type:t.getInvoiceStatusType(t.invoice.status)},{default:l(()=>[m(f(t.getInvoiceStatusText(t.invoice.status)),1)]),_:1},8,["type"])])])])):E("",!0)]}),_:1})),[[T,t.loading]]),n(b,{class:"payments-card"},{default:l(()=>[e[25]||(e[25]=s("div",{class:"card-title"},"支付记录列表",-1)),n(M,{data:t.payments,border:"",style:{width:"100%"}},{default:l(()=>[n(p,{prop:"paymentAmount",label:"支付金额",width:"120"},{default:l(o=>[m(f(t.formatCurrency(o.row.paymentAmount)),1)]),_:1}),n(p,{prop:"paymentMethod",label:"支付方式",width:"120"},{default:l(o=>[m(f(t.getPaymentMethodText(o.row.paymentMethod)),1)]),_:1}),n(p,{prop:"paymentDate",label:"支付日期",width:"120"}),n(p,{prop:"paymentStatus",label:"支付状态",width:"100"},{default:l(o=>[n(g,{type:t.getPaymentStatusType(o.row.paymentStatus)},{default:l(()=>[m(f(t.getPaymentStatusText(o.row.paymentStatus)),1)]),_:2},1032,["type"])]),_:1}),n(p,{prop:"reviewedBy",label:"审核人",width:"120"}),n(p,{prop:"reviewedAt",label:"审核时间",width:"180"}),n(p,{prop:"reviewRemarks",label:"审核备注","min-width":"150"}),n(p,{label:"凭证",width:"100"},{default:l(o=>[o.row.voucherUrl?(v(),D(d,{key:0,size:"small",type:"primary",onClick:w=>t.previewVoucher(o.row.voucherUrl)},{default:l(()=>e[20]||(e[20]=[m(" 查看 ")])),_:2},1032,["onClick"])):(v(),j("span",Ge,"无"))]),_:1}),n(p,{label:"操作",width:"200"},{default:l(o=>[o.row.paymentStatus==="pending"?(v(),D(d,{key:0,size:"small",type:"success",onClick:w=>t.handleReview(o.row,"approved")},{default:l(()=>e[21]||(e[21]=[m(" 审核通过 ")])),_:2},1032,["onClick"])):E("",!0),o.row.paymentStatus==="pending"?(v(),D(d,{key:1,size:"small",type:"danger",onClick:w=>t.handleReview(o.row,"rejected")},{default:l(()=>e[22]||(e[22]=[m(" 拒绝 ")])),_:2},1032,["onClick"])):E("",!0),o.row.paymentStatus==="pending"?(v(),D(d,{key:2,size:"small",type:"primary",onClick:w=>t.handleEdit(o.row)},{default:l(()=>e[23]||(e[23]=[m(" 编辑 ")])),_:2},1032,["onClick"])):E("",!0),o.row.paymentStatus==="pending"?(v(),D(d,{key:3,size:"small",type:"danger",onClick:w=>t.handleDelete(o.row)},{default:l(()=>e[24]||(e[24]=[m(" 删除 ")])),_:2},1032,["onClick"])):E("",!0)]),_:1})]),_:1},8,["data"])]),_:1}),n(A,{modelValue:t.paymentDialogVisible,"onUpdate:modelValue":e[5]||(e[5]=o=>t.paymentDialogVisible=o),title:t.isEditPayment?"编辑支付记录":"添加支付记录",width:"50%"},{footer:l(()=>[s("span",Je,[n(d,{onClick:e[4]||(e[4]=o=>t.paymentDialogVisible=!1)},{default:l(()=>e[28]||(e[28]=[m("取消")])),_:1}),n(d,{type:"primary",onClick:t.submitPaymentForm,loading:t.submitting},{default:l(()=>e[29]||(e[29]=[m(" 确认 ")])),_:1},8,["onClick","loading"])])]),default:l(()=>[n(k,{ref:"paymentFormRef",model:t.paymentForm,rules:t.paymentRules,"label-width":"100px"},{default:l(()=>[n(y,{label:"支付金额",prop:"paymentAmount"},{default:l(()=>{var o;return[n(C,{modelValue:t.paymentForm.paymentAmount,"onUpdate:modelValue":e[0]||(e[0]=w=>t.paymentForm.paymentAmount=w),precision:2,step:100,min:0,max:((o=t.invoice)==null?void 0:o.unpaidAmount)||0,style:{width:"100%"}},null,8,["modelValue","max"])]}),_:1}),n(y,{label:"支付方式",prop:"paymentMethod"},{default:l(()=>[n(x,{modelValue:t.paymentForm.paymentMethod,"onUpdate:modelValue":e[1]||(e[1]=o=>t.paymentForm.paymentMethod=o),placeholder:"请选择支付方式",style:{width:"100%"}},{default:l(()=>[n(V,{label:"现金",value:"cash"}),n(V,{label:"银行转账",value:"bank"}),n(V,{label:"其他",value:"other"})]),_:1},8,["modelValue"])]),_:1}),n(y,{label:"支付日期",prop:"paymentDate"},{default:l(()=>[n(i,{modelValue:t.paymentForm.paymentDate,"onUpdate:modelValue":e[2]||(e[2]=o=>t.paymentForm.paymentDate=o),type:"date",placeholder:"选择日期",style:{width:"100%"},"value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),n(y,{label:"支付凭证",prop:"voucherFile"},{default:l(()=>[n(R,{class:"upload-demo",action:"#","auto-upload":!1,"on-change":t.handleFileChange,limit:1,"file-list":t.fileList},{trigger:l(()=>[n(d,{type:"primary"},{default:l(()=>e[26]||(e[26]=[m("选择文件")])),_:1})]),tip:l(()=>e[27]||(e[27]=[s("div",{class:"el-upload__tip"}," 支持jpg/png格式，不超过5MB ",-1)])),_:1},8,["on-change","file-list"])]),_:1}),n(y,{label:"备注",prop:"remarks"},{default:l(()=>[n(_,{type:"textarea",rows:3,modelValue:t.paymentForm.remarks,"onUpdate:modelValue":e[3]||(e[3]=o=>t.paymentForm.remarks=o),placeholder:"请输入备注信息"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"]),n(A,{modelValue:t.reviewDialogVisible,"onUpdate:modelValue":e[9]||(e[9]=o=>t.reviewDialogVisible=o),title:"审核支付记录",width:"40%"},{footer:l(()=>[s("span",Qe,[n(d,{onClick:e[8]||(e[8]=o=>t.reviewDialogVisible=!1)},{default:l(()=>e[32]||(e[32]=[m("取消")])),_:1}),n(d,{type:"primary",onClick:t.submitReview,loading:t.submitting},{default:l(()=>e[33]||(e[33]=[m(" 确认 ")])),_:1},8,["onClick","loading"])])]),default:l(()=>[n(k,{ref:"reviewFormRef",model:t.reviewForm,"label-width":"100px"},{default:l(()=>[n(y,{label:"审核结果"},{default:l(()=>[n(U,{modelValue:t.reviewForm.status,"onUpdate:modelValue":e[6]||(e[6]=o=>t.reviewForm.status=o)},{default:l(()=>[n(S,{label:"approved"},{default:l(()=>e[30]||(e[30]=[m("通过")])),_:1}),n(S,{label:"rejected"},{default:l(()=>e[31]||(e[31]=[m("拒绝")])),_:1})]),_:1},8,["modelValue"])]),_:1}),n(y,{label:"审核备注"},{default:l(()=>[n(_,{type:"textarea",rows:3,modelValue:t.reviewForm.remarks,"onUpdate:modelValue":e[7]||(e[7]=o=>t.reviewForm.remarks=o),placeholder:"请输入审核备注"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),n(A,{modelValue:t.voucherDialogVisible,"onUpdate:modelValue":e[10]||(e[10]=o=>t.voucherDialogVisible=o),title:"支付凭证",width:"50%"},{default:l(()=>[s("div",We,[s("img",{src:t.currentVoucherUrl,alt:"支付凭证",style:{"max-width":"100%"}},null,8,Ze)])]),_:1},8,["modelValue"])])}const dt=$(Ae,[["render",He],["__scopeId","data-v-93ea2c43"]]);export{dt as default};
